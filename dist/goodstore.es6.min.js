import{Arr,Dictionary,Initable,Pool,Poolable,Range2,Rect,Test,Util,Vec2}from"goodcore";import{BehaviorSubject as BehaviorSubject$1}from"rxjs/BehaviorSubject";class CallerInternal{constructor(e,t){this._fixedLoadPort=new Range2,this._fixedPxLoadPort=new Range2,this.totalCells=new Vec2(-1,-1),this.totalPx=new Vec2(-1,-1),this._config=e,this._stream=t,this.fetchSubscription=null,this.ignoreFetch=-1,this.requestId=-1}get config(){return this._config}set config(e){this._config=e}get stream(){return this._stream}get loadPort(){return this.config.loadPort}set loadPort(e){this.config.loadPort=e}get pxLoadPort(){return this.config.pxLoadPort}set pxLoadPort(e){this.config.pxLoadPort=e}get fixedLoadPort(){return this._fixedLoadPort}get fixedPxLoadPort(){return this._fixedLoadPort}get viewPort(){return this.config.viewPort}set viewPort(e){this.config.viewPort.equals(e)||this.ignoreOngoingFetch(),this.config.viewPort=e}get pxViewPort(){return this.config.pxViewPort}set pxViewPort(e){this.config.pxViewPort.equals(e)||this.ignoreOngoingFetch(),this.config.pxViewPort=e}fixLoadPort(){this.config.pxLoadPort.isZero?(this._fixedLoadPort.set(this.config.loadPort),this._fixedPxLoadPort.zero()):(this._fixedPxLoadPort.set(this.config.pxLoadPort),this._fixedLoadPort.zero())}ignoreOngoingFetch(){null!==this.fetchSubscription&&(this.ignoreFetch=this.requestId)}cancelOngoingFetch(){null!==this.fetchSubscription&&(this.fetchSubscription.unsubscribe(),this.fetchSubscription=null)}limitLoadPortByTotalCells(){this.limitPortByTotal(this.loadPort,this.totalCells)}limitPxLoadPortByTotalPx(){this.limitPortByTotal(this.pxLoadPort,this.totalPx)}limitPortByTotal(e,t){if(!e.isZero&&!t.equals({x:-1,y:-1})){let r=e.toRect().stop.subtract(t).max(new Vec2(0,0));e.size.subtract(r)}}}class CallerHandle{constructor(e,t,r){this._force=!1,this._id=e,this._store=t,this._stream=new BehaviorSubject$1(null),this._internal=new CallerInternal(r,this._stream)}get internal(){return this._internal}get stream(){return this._stream}get viewPort(){return this._internal.viewPort}set viewPort(e){this._internal.viewPort=e}get pxViewPort(){return this._internal.pxViewPort}set pxViewPort(e){this._internal.pxViewPort=e}get requestMargin(){return this._internal.config.requestMargin}set requestMargin(e){this._internal.config.requestMargin=e}load(e){this.readConfig(e),this._store.load(this.internal,this._force)}unregister(){throw new Error("not implemented")}readConfig(e){void 0!==e&&(void 0!==e.requestMargin&&(this.internal.config.requestMargin=e.requestMargin),void 0!==e.viewPort&&(this.viewPort=e.viewPort),void 0!==e.pxViewPort&&(this.pxViewPort=e.pxViewPort),this._force=!0===e.forceStream)}}var __decorate=function(e,t,r,a){var o,s=arguments.length,i=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};let DataStoreConsumable=class{constructor(){this.totalCells=new Vec2,this.totalPx=new Vec2,this.loadPort=null,this.pxScope=new Rect,this.rows=null}init(e){throw new Error("Method not implemented.")}};DataStoreConsumable=__decorate([Initable],DataStoreConsumable);var __decorate$1=function(e,t,r,a){var o,s=arguments.length,i=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};let DataStoreRequestDto=class{init(e){throw new Error("Method not implemented.")}};DataStoreRequestDto=__decorate$1([Initable],DataStoreRequestDto);var __decorate$2=function(e,t,r,a){var o,s=arguments.length,i=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},__metadata=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let DataRow=class{constructor(e=0){this.i=0,this.h=0,this.d=null,this.c=new Array(e)}init(e){throw new Error("Method not implemented.")}release(){throw new Error("Method not implemented.")}initPool(e){throw new Error("Method not implemented.")}};DataRow=__decorate$2([Poolable,Initable,__metadata("design:paramtypes",[Number])],DataRow);var __decorate$3=function(e,t,r,a){var o,s=arguments.length,i=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},__metadata$1=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let DataPage=class{constructor(){this._id=0,this._r=[],this._pxScope=new Rect,this._cellSize=new Vec2,this._r=new Array}release(){throw new Error("Method not implemented.")}initPool(e){throw new Error("Method not implemented.")}get id(){return this._id}set id(e){this._id=e}get r(){return this._r}get pxScope(){return this._pxScope}set pxScope(e){this._pxScope.set(e)}get cellSize(){return this._cellSize}set cellSize(e){this._cellSize.set(e),this.initData(e)}addRow(){const e=new DataRow;return this._r.push(e),e}initData(e){let t=-1;void 0===this._r&&(this._r=[]);let r=this._r,a=r.length-1,o=Math.min(a,e.y);for(;++a<e.y;)r.push(new DataRow(e.x));for(r.length!==e.y&&(r.length=e.y);++t<o;)r[t].c.length=e.x}};DataPage=__decorate$3([Poolable,Initable,__metadata$1("design:paramtypes",[])],DataPage);class PageStore{constructor(e,t,r=null){this.isDebug=!0,this._usePx=!0,this._dummyRect=new Rect,this._pagePool=new Pool(DataPage),this._pageLookup=new Dictionary,this._requestedPages=new Dictionary,this._pageQueue=new Array,this._cellsPerPage=new Vec2,this._pagesPerCell=new Vec2,this.setPageSize(e),this._retainSize=t,this._totalPages=new Vec2,this._totalCells=new Vec2,this._totalPx=new Vec2,this._pagePxRanges=r,this._usePx=null!==r}get totalPx(){return this._totalPx}get totalCells(){return this._totalCells}get totalPages(){return this._totalPages}setPageSize(e){this._cellsPerPage.equals(e)||this.emptyPageStore(),this._cellsPerPage.set(e),this._pagesPerCell.x=1/e.x,this._pagesPerCell.y=1/e.y}isRequestedDataLoaded(e){let t=!1;const r=!e.loadPort.isZero,a=!e.pxLoadPort.isZero;(r||a)&&(t=null===(r?this.cellRangeToPageRange(e.loadPort):this.pxRangeToPageRange(e.pxLoadPort)).first(e=>!this._pageLookup.has(e.y*this._totalPages.x+e.x)));return t}limitPagesToLoad(e){const t=e.clone(),r=e.toRect();let a=!1;for(let e=r.start.y;e<r.stop.y;e+=1){for(let t=r.start.x;t<r.stop.x;t+=1)if(!this._pageLookup.has(e*this._cellsPerPage.x+t)&&!this._requestedPages.has(e*this._cellsPerPage.x+t)){a=!0;break}if(a)break;t.pos.y+=1,t.size.y-=1}a=!1;for(let e=r.stop.y;e>r.start.y;e-=1){for(let t=r.start.x;t<r.stop.x;t+=1)if(!this._pageLookup.has(e*this._cellsPerPage.x+t)&&!this._requestedPages.has(e*this._cellsPerPage.x+t)){a=!0;break}if(a)break;t.size.y-=1}a=!1;for(let e=r.start.x;e<r.stop.x;e+=1){for(let t=r.start.y;t<r.stop.y;t+=1)if(!this._pageLookup.has(t*this._cellsPerPage.x+e)&&!this._requestedPages.has(t*this._cellsPerPage.x+e)){a=!0;break}if(a)break;t.pos.x+=1,t.size.x-=1}a=!1;for(let e=r.stop.x;e>r.start.x;e-=1){for(let t=r.start.y;t<r.stop.y;t+=1)if(!this._pageLookup.has(t*this._cellsPerPage.x+e)&&!this._requestedPages.has(t*this._cellsPerPage.x+e)){a=!0;break}if(a)break;t.size.x-=1}return t}cellSpaceToPageSpaceX(e){return e/this._cellsPerPage.x|0}cellSpaceToPageSpaceY(e){return e/this._cellsPerPage.y|0}cellSpaceToInnerPageSpaceX(e){return e-this._cellsPerPage.x*this.cellSpaceToPageSpaceX(e)}cellSpaceToInnerPageSpaceY(e){return e-this._cellsPerPage.y*this.cellSpaceToPageSpaceY(e)}pxRangeToPageRange(e){Util.assert(!!this._pagePxRanges.x&&!!this._pagePxRanges.y,"pagePxRanges does not contain valid ranges");let t=e.pos.x,r=Arr.binarySearch(this._pagePxRanges.x,e=>e.p+e.s<=t?-1:e.p>t?1:0),a=e.pos.y,o=Arr.binarySearch(this._pagePxRanges.y,e=>e.p+e.s<=a?-1:e.p>a?1:0),s=e.pos.x+e.size.x-1,i=Arr.binarySearch(this._pagePxRanges.x,e=>e.p+e.s<=s?-1:e.p>s?1:0),n=e.pos.y+e.size.y-1,l=Arr.binarySearch(this._pagePxRanges.y,e=>e.p+e.s<=n?-1:e.p>n?1:0);return new Rect(r,o,i,l,!0).toRange2()}cellRangeToPageRange(e){let t=(new Range2).set(e);const r=t.toRect(!1,this._dummyRect).translate(this._pagesPerCell);return r.start.toInt(),r.stop.ceil(),r.toRange2(t),t}pageRangeToCellRange(e){return(new Range2).set(e).translate(this._cellsPerPage).toInt()}pxRangeToCellRange(e){const t=this.pxRangeToPageRange(e),r=this.getDataPagesForPageRange(t);let a=r[0].pxScope.start.clone(),o=0;Arr.until(r[0].r[0].c,(t,r)=>e.pos.x<a.x+t.w,(e,t)=>{a.x+=e.w,++o});let s=0;Arr.until(r[0].r,(t,r)=>e.pos.y<a.y+t.h,(e,t)=>{a.y+=e.h,++s}),a=r[r.length-1].pxScope.start.clone();let i=0;Arr.until(r[r.length-1].r[0].c,(t,r)=>e.pos.x+e.size.x-1<a.x+t.w,(e,t)=>{a.x+=e.w,++i});let n=0;Arr.until(r[r.length-1].r,(t,r)=>e.pos.y+e.size.y-1<a.y+t.h,(e,t)=>{a.y+=e.h,++n});let l=r[0].r[s].c[o].i,h=r[r.length-1].r[n].c[i].i;return new Rect(l.x,l.y,h.x,h.y,!0).toRange2()}addDataToPageStore(e,t){this.partitionDataIntoPages(t.r,t.dataPort,t.pxScope).forEach(e=>this.insertPage(e)),this.cleanPageStore(e)}readPropertiesFromResponse(e){this._totalCells.equals(e.totalCells)||(this._totalPages.set(e.totalCells).scale(this._pagesPerCell),this._totalCells.set(e.totalCells),this._usePx&&this._totalPx.set(e.totalPx))}emptyPageStore(){for(;this._pageQueue.length>0;)this.shiftPageQueue()}cleanPageStore(e){let t=this.calculateLockedPages(e),r=Math.max(this._retainSize,t.list.count);Arr.reverse(this._pageQueue),Arr.reverseUntil(this._pageQueue,(e,t)=>this._pageQueue.length<=r,(e,r)=>{t.has(""+this._pageQueue[r].id)||this.removePageFromQueue(this._pageQueue[r])}),Arr.reverse(this._pageQueue)}removePageFromQueue(e){Arr.remove(this._pageQueue,e),this.deletePageById(e.id),e.release()}shiftPageQueue(){const e=this._pageQueue.shift();this.deletePageById(e.id),e.release()}deletePageById(e){this._pageLookup.has(e)&&this._pageLookup.delete(e)}partitionDataIntoPages(e,t,r){const a=this.cellRangeToPageRange(t).toRect(),o=new Array;let s=0;for(let t=a.start.y;t<a.stop.y;++t){let r=0;for(let i=a.start.x;i<a.stop.x;++i){const a=t*this._totalPages.x+i;if(!this._pageLookup.has(a)){const n=this._pagePool.get();if(n.id=a,n.cellSize=this._cellsPerPage,this._usePx){let e=this._pagePxRanges.x[i],r=this._pagePxRanges.y[t],a=n.pxScope;a.start.x=e.p,a.start.y=r.p,a.stop.x=e.p+e.s-1,a.stop.y=r.p+r.s-1}o.push(n);const l=s*this._cellsPerPage.y,h=r*this._cellsPerPage.x,g=l+this._cellsPerPage.y,c=h+this._cellsPerPage.x;let P=0;for(let t=l;t<g&&t<e.length;++t){const r=e[t],a=n.r[P];a.h=r.h,a.i=r.i,a.d=r.d;let o=0;for(let e=h;e<c&&e<r.c.length;++e)a.c[o]=r.c[e],++o;++P}}++r}++s}return o}insertPage(e){!this._pageLookup.has(e.id)||Arr.removeOneByFn(this._pageQueue,function(t){return t.id===e.id}),this._pageQueue.push(e),this._pageLookup.set(e.id,e)}calculateLockedPages(e){let t=new Dictionary;return Arr.forEach(Arr.flatten(Arr.map(e,e=>this.getPageIdsForViewPort(e.loadPort))),e=>t.set(e,e)),t}assembleDataFromPages(e){const t=new Array;let r=this.getLoadPort(e);Util.loop(r.size.y,e=>t.push(new DataRow(r.size.x)));const a=this.getDataPages(e),o=r.toRect(),s=this.cellRangeToPageRange(r),i=new Vec2,n=new Vec2,l=new Vec2,h=new Vec2;let g;const c=t.length,P=void 0===t[0]?0:t[0].c.length,p=new Vec2;for(i.y=o.start.y;i.y<o.stop.y&&n.y<c;i.y+=1,n.y+=1){l.y=this.cellSpaceToPageSpaceY(i.y),n.x=0,h.y=this.cellSpaceToInnerPageSpaceY(i.y),p.set(l).subtract(s.pos);let e=a[g=p.y*s.size.x+p.x].r[h.y];for(t[n.y].init({i:e.i,h:e.h,d:e.d}),i.x=o.start.x;i.x<o.stop.x&&n.x<P;i.x+=1,n.x+=1)l.x=this.cellSpaceToPageSpaceX(i.x),h.x=this.cellSpaceToInnerPageSpaceX(i.x),h.y=this.cellSpaceToInnerPageSpaceY(i.y),p.set(l).subtract(s.pos),g=p.y*s.size.x+p.x,t[n.y].c[n.x]=a[g].r[h.y].c[h.x]}return t}getPageIdsForViewPort(e){const t=[];return this.cellRangeToPageRange(e).forEach(e=>{const r=e.y*this._cellsPerPage.x+e.x;return this._pageLookup.has(r)&&t.push(this._pageLookup.get(r).id),!1}),t}getLoadPort(e){return!e.loadPort.isZero?e.loadPort:this.pxRangeToCellRange(e.pxLoadPort)}getDataPages(e){return!e.loadPort.isZero?this.getDataPagesForCellPort(e.loadPort):this.getDataPagesForPxPort(e.pxLoadPort)}getDataPagesForCellPort(e){const t=this.cellRangeToPageRange(e);return this.getDataPagesForPageRange(t)}getDataPagesForPxPort(e){const t=this.pxRangeToPageRange(e);return this.getDataPagesForPageRange(t)}getDataPagesForPageRange(e){const t=new Array;return e.forEach(e=>{const r=e.y*this._totalPages.x+e.x;return this._pageLookup.has(r)&&t.push(this._pageLookup.get(r)),!1}),t}}class DataStore{constructor(e){this.isDebug=!0,this._id=Util.newUUID(),this._usePx=!0,this._requestCounter=0,this._handleCounter=0,this._callers=[],this._pageStore=null,this._endPointFn=e.endPointFn?e.endPointFn:DataStore.DEFAULT_CONFIG.endPointFn,this._pageStore=new PageStore(e.pageSize||DataStore.DEFAULT_CONFIG.pageSize,e.retainSize?e.retainSize:DataStore.DEFAULT_CONFIG.retainSize,e.pagePxRanges)}load(e,t=!1){Util.assert(Test.isFunction(this._endPointFn),"EndPoint is valid function",this.isDebug),Util.assert(void 0!==e.viewPort,"ViewPort is defined",this.isDebug),(this.loadPortHasChanged(e)||t)&&(e.limitLoadPortByTotalCells(),e.limitPxLoadPortByTotalPx(),this._pageStore.isRequestedDataLoaded(e)?(this.addDataToStream(e,t),this._pageStore.cleanPageStore(this._callers)):e.fetchSubscription=this.fetchData(e).subscribe(r=>{Util.assert(void 0!==r,"Payload from server was empty in DataStore.load()",this.isDebug)&&(this.readPropertiesFromResponse(e,r),e.limitLoadPortByTotalCells(),e.limitPxLoadPortByTotalPx(),this._pageStore.addDataToPageStore(this._callers,r),e.ignoreFetch<e.requestId&&this.addDataToStream(e,t))},t=>{e.cancelOngoingFetch(),this.onDataFail(e,t)}))}loadPortHasChanged(e){const t=e.loadPort,r=e.pxLoadPort;return!t.isZero&&!t.equals(e.fixedLoadPort)||!r.isZero&&!r.equals(e.fixedPxLoadPort)}readPropertiesFromResponse(e,t){e.totalCells=(new Vec2).set(t.totalCells),this._usePx=!!t.pxScope,this._usePx&&e.totalPx.set(t.totalPx),t.cellsPerPage&&this._pageStore.setPageSize(t.cellsPerPage),this._pageStore.readPropertiesFromResponse(t)}register(e){const t=new CallerHandle(this._handleCounter,this,e);return this._handleCounter+=1,this._callers.push(t.internal),t}fetchData(e){const t=this.createRequestDTO(e);return e.requestId=this._requestCounter,e.cancelOngoingFetch(),this._endPointFn(t)}createRequestDTO(e){let t=null,r=null;r=e.pxViewPort.isZero?this._pageStore.cellRangeToPageRange(e.loadPort):this._pageStore.pxRangeToPageRange(e.pxLoadPort),r=this._pageStore.limitPagesToLoad(r),t=this._pageStore.pageRangeToCellRange(r);const a=(new DataStoreRequestDto).init({sourceId:this._id,requestId:this._requestCounter,cellRequest:t});return this._requestCounter+=1,a}onDataFail(e,t){throw new Error("Not Implemented")}addDataToStream(e,t=!1){if(!this.viewPortIsAlreadyStreamed(e)||t){e.fixLoadPort();const t=this._pageStore.getLoadPort(e),r=this._pageStore.assembleDataFromPages(e);let a=null;this._usePx&&(a=this.calculatePxRangeFromCellRange(t));let o=new DataStoreConsumable;o.init({totalCells:this._pageStore.totalCells,totalPx:this._pageStore.totalPx,loadPort:t,rows:r,pxScope:a}),e.stream.next(o)}}viewPortIsAlreadyStreamed(e){return!e.viewPort.isZero&&e.fixedLoadPort.contains(e.viewPort)||!e.pxViewPort.isZero&&e.fixedPxLoadPort.contains(e.pxViewPort)}calculatePxRangeFromCellRange(e){let t=new Rect;const r=this._pageStore.getDataPagesForCellPort(e),a=e.toRect();let o=r[0].pxScope.start.clone(),s=r[r.length-1].pxScope.stop.clone(),i=r[0].r[0].c[0].i.x,n=r[0].r[0].c[r[0].r[0].c.length-1].i.x,l=r[0].r[0].i,h=(r[r.length-1].r[r[r.length-1].r.length-1].i,Arr.shallowCopy(r[0].r[0].c));Arr.until(h,(e,t)=>t+i>=a.start.x,(e,t)=>o.x+=e.w),Arr.reverse(h),Arr.until(h,(e,t)=>n-t>=a.start.x,(e,t)=>s.x-=e.w);let g=Arr.shallowCopy(r[0].r);return Arr.until(g,(e,t)=>t+l>=a.start.y,(e,t)=>o.y+=e.h),Arr.reverse(g),Arr.until(g,(e,t)=>n-t>=a.start.y,(e,t)=>s.y-=e.h),t.start=o,t.stop=s,t}}DataStore.DEFAULT_CONFIG={pageSize:new Vec2(10,10),retainSize:10,endPointFn:null};var __decorate$4=function(e,t,r,a){var o,s=arguments.length,i=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};let RequestConfig=class{constructor(){this._viewPort=new Range2,this._pxViewPort=new Range2,this._requestMargin=new Vec2(0,0),this._loadPort=new Range2,this._pxLoadPort=new Range2,this._pxRequestMargin=new Vec2(0,0)}init(e){throw new Error("Method not implemented.")}get viewPort(){return this._viewPort}set viewPort(e){this._viewPort.set(e),this._loadPort=this.calculateLoadPort(this._viewPort,this._requestMargin),this._pxViewPort.zero(),this._pxLoadPort.zero()}get requestMargin(){return this._requestMargin}set requestMargin(e){this._requestMargin.set(e),this._loadPort=this.calculateLoadPort(this._viewPort,this._requestMargin)}get pxViewPort(){return this._pxViewPort}set pxViewPort(e){this._pxViewPort.set(e),this._pxLoadPort=this.calculateLoadPort(this._pxViewPort,this._pxRequestMargin),this._viewPort.zero(),this._loadPort.zero()}get pxRequestMargin(){return this._pxRequestMargin}set pxRequestMargin(e){this._pxRequestMargin.set(e),this._pxLoadPort=this.calculateLoadPort(this._pxViewPort,this._pxRequestMargin)}get loadPort(){return this._loadPort}set loadPort(e){this._loadPort.set(e),this._pxLoadPort.zero()}get pxLoadPort(){return this._pxLoadPort}set pxLoadPort(e){this._pxLoadPort.set(e),this._loadPort.zero()}calculateLoadPort(e,t){let r=e.clone();r.pos.subtract(t),r.size.add(t.clone().multiply(2));let a=r.pos.clone().invert().max({x:0,y:0});return r.pos.add(a),r.size.subtract(a),r}};RequestConfig=__decorate$4([Initable],RequestConfig);export{DataStore,DataStoreConsumable,DataStoreRequestDto,RequestConfig};
//# sourceMappingURL=goodstore.es6.min.js.map
